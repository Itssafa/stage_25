<div class="ordre-fab-container">
  <h2>Gestion des Ordres de Fabrication</h2>
  
  <!-- Barre de recherche globale -->
  <app-advanced-search
    placeholder="Rechercher un ordre de fabrication..."
    (globalSearchChange)="onSearchChange($event)"
    (clearSearch)="onClearSearch()">
  </app-advanced-search>

  <!-- Liste des ordres de fabrication -->
  <div class="list-section">
    <div class="list-header">
      <h3>Liste des ordres de fabrication</h3>
      <button (click)="openAddModal()" class="btn btn-add">+</button>
    </div>
    
    <div *ngIf="loading" class="loading">Chargement...</div>
    <div *ngIf="error" class="error">{{ error }}</div>
    
    <table *ngIf="filteredOrdresFab.length > 0" class="table">
      <thead>
        <tr>
          <th>ID</th>
          <th>Code Fab</th>
          <th>Statut</th>
          <th>Quantit√©</th>
          <th>Date d√©but</th>
          <th>Date fin</th>
          <th>Cr√©√© par</th>
          <th>Produit</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let ordreFab of filteredOrdresFab">
          <td>{{ ordreFab.id_orf }}</td>
          <td>{{ ordreFab.code_fab }}</td>
          <td>{{ ordreFab.statuts.replace('_', ' ') }}</td>
          <td>{{ ordreFab.quantite }}</td>
          <td>{{ ordreFab.datedeb | date:'dd/MM/yyyy' }}</td>
          <td>{{ ordreFab.datefin | date:'dd/MM/yyyy' }}</td>
          <td>{{ ordreFab.user?.username }} ({{ ordreFab.user?.prenom }})</td>
          <td>{{ ordreFab.produit?.nom || 'N/A' }}</td>
          <td>
            <button 
              *ngIf="ordreFab.statuts !== 'TERMINEE' && ordreFab.statuts !== 'ANNULEE'"
              (click)="editOrdreFab(ordreFab)" 
              class="btn btn-edit"
              title="Modifier cet ordre">
              Modifier
            </button>
            <button 
              (click)="deleteOrdreFab(ordreFab.id_orf!)" 
              class="btn btn-delete"
              [disabled]="ordreFab.statuts === 'TERMINEE'"
              [class.disabled-final]="ordreFab.statuts === 'TERMINEE'"
              [title]="ordreFab.statuts === 'TERMINEE' ? 'Ordre termin√©, suppression impossible' : 'Supprimer cet ordre'">
              Supprimer
            </button>
          </td>
        </tr>
      </tbody>
    </table>
    
    <div *ngIf="filteredOrdresFab.length === 0 && ordresFab.length > 0 && !loading" class="no-data">
      Aucun ordre de fabrication ne correspond aux crit√®res de recherche
    </div>
    
    <div *ngIf="ordresFab.length === 0 && !loading" class="no-data">
      Aucun ordre de fabrication trouv√©
    </div>
  </div>
</div>

<!-- Modal pour formulaire d'ajout/modification -->
<div *ngIf="showModal" class="modal-overlay" (click)="closeModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>{{ isEditing ? 'Modifier' : 'Ajouter' }} un ordre de fabrication</h3>
      <button class="close-btn" (click)="closeModal()">&times;</button>
    </div>
    
    
    <div class="modal-body">
      <form [formGroup]="ordreFabForm" (ngSubmit)="onSubmit()">
        <div class="form-group" *ngIf="!isEditing || ordreFabForm.get('statuts')?.value === 'EN_ATTENTE'">
          <label for="code_fab">Code de fabrication:</label>
          <input 
            type="text" 
            id="code_fab" 
            formControlName="code_fab" 
            class="form-control"
            [class.disabled-field]="ordreFabForm.get('code_fab')?.disabled"
            placeholder="Entrez le code de fabrication">
          <div *ngIf="ordreFabForm.get('code_fab')?.invalid && ordreFabForm.get('code_fab')?.touched" class="error">
            Le code de fabrication est requis (minimum 3 caract√®res)
          </div>
        </div>

        <!-- Champ statut uniquement visible lors de la modification -->
        <div class="form-group" *ngIf="isEditing">
          <label for="statuts">Statut:</label>
          <select 
            id="statuts" 
            formControlName="statuts" 
            class="form-control"
            [class.disabled-field]="ordreFabForm.get('statuts')?.disabled">
            <option *ngFor="let statut of statuts" [value]="statut">
              {{ statut.replace('_', ' ') }}
            </option>
          </select>
          <div *ngIf="ordreFabForm.get('statuts')?.invalid && ordreFabForm.get('statuts')?.touched" class="error">
            Veuillez s√©lectionner un statut
          </div>
        </div>
        
        <!-- Message informatif lors de la cr√©ation -->
        <div *ngIf="!isEditing" class="info-message">
          üìã Le statut sera automatiquement d√©fini √† "EN ATTENTE" lors de la cr√©ation
        </div>
        
        <div class="form-group">
          <label for="quantite">Quantit√©:</label>
          <input 
            type="number" 
            id="quantite" 
            formControlName="quantite" 
            class="form-control"
            placeholder="Entrez la quantit√©"
            min="1">
          <div *ngIf="ordreFabForm.get('quantite')?.invalid && ordreFabForm.get('quantite')?.touched" class="error">
            La quantit√© est requise (minimum 1)
          </div>
        </div>
        
        <div class="form-group" *ngIf="!isEditing || ordreFabForm.get('statuts')?.value === 'EN_ATTENTE'">
          <label for="datedeb">Date de d√©but:</label>
          <input 
            type="date" 
            id="datedeb" 
            formControlName="datedeb" 
            class="form-control"
            [class.disabled-field]="ordreFabForm.get('datedeb')?.disabled">
          <div *ngIf="ordreFabForm.get('datedeb')?.invalid && ordreFabForm.get('datedeb')?.touched" class="error">
            <div *ngIf="ordreFabForm.get('datedeb')?.errors?.['required']">
              La date de d√©but est requise
            </div>
            <div *ngIf="ordreFabForm.get('datedeb')?.errors?.['dateDebutInvalide']">
              {{ ordreFabForm.get('datedeb')?.errors?.['dateDebutInvalide'].message }}
            </div>
          </div>
        </div>
        
        <div class="form-group">
          <label for="datefin">Date de fin:</label>
          <input 
            type="date" 
            id="datefin" 
            formControlName="datefin" 
            class="form-control">
          <div *ngIf="ordreFabForm.get('datefin')?.invalid && ordreFabForm.get('datefin')?.touched" class="error">
            <div *ngIf="ordreFabForm.get('datefin')?.errors?.['required']">
              La date de fin est requise
            </div>
            <div *ngIf="ordreFabForm.get('datefin')?.errors?.['dateFinInvalide']">
              {{ ordreFabForm.get('datefin')?.errors?.['dateFinInvalide'].message }}
            </div>
          </div>
          <!-- Message d'erreur pour la validation de plage de dates -->
          <div *ngIf="ordreFabForm.errors?.['dateRangeInvalide'] && ordreFabForm.get('datefin')?.touched" class="error">
            {{ ordreFabForm.errors?.['dateRangeInvalide'].message }}
          </div>
        </div>

        
        <div class="form-group" *ngIf="!isEditing || ordreFabForm.get('statuts')?.value === 'EN_ATTENTE'">
          <label for="produitId">Produit:</label>
          <select 
            id="produitId" 
            formControlName="produitId" 
            class="form-control"
            [class.disabled-field]="ordreFabForm.get('produitId')?.disabled">
            <option value="">S√©lectionnez un produit</option>
            <option *ngFor="let produit of produits" [value]="produit.idProduit">
              {{ produit.nom }} ({{ produit.type }})
            </option>
          </select>
          <div *ngIf="ordreFabForm.get('produitId')?.invalid && ordreFabForm.get('produitId')?.touched" class="error">
            Veuillez s√©lectionner un produit
          </div>
        </div>
        
        <div class="form-actions">
          <button 
            type="submit" 
            [disabled]="ordreFabForm.invalid || (isEditing && (ordreFabForm.get('statuts')?.value === 'FINI' || ordreFabForm.get('statuts')?.value === 'ANNULE'))" 
            class="btn btn-primary"
            [class.disabled-final-status]="isEditing && (ordreFabForm.get('statuts')?.value === 'FINI' || ordreFabForm.get('statuts')?.value === 'ANNULE')">
            {{ isEditing ? 'Mettre √† jour' : 'Ajouter' }}
          </button>
          <button type="button" (click)="closeModal()" class="btn btn-secondary">
            Annuler
          </button>
        </div>
        
        <!-- Message explicatif pour les √©tats finaux -->
        <div *ngIf="isEditing && (ordreFabForm.get('statuts')?.value === 'FINI' || ordreFabForm.get('statuts')?.value === 'ANNULE')" class="final-status-message">
          üö´ <strong>Ordre fig√© :</strong> Cet ordre a √©t√© finalis√© et ne peut plus √™tre modifi√©.
        </div>
      </form>
    </div>
  </div>
</div>